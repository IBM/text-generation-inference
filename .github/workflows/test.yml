# generated by gh-actions-importer:
#   gh actions-importer dry-run travis-ci --source-file-path .travis.yml -o .github/workflows -r ibm/text-generation-inference
name: Test

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths-ignore:
#      - '.github/**'
      - '**.md'
      - 'proto/**'

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      CI: true
      DOCKER_BUILDKIT: 1
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2
#    - run: make docker-login-artifactory
    - run: "./scripts/with_dots.sh make build-test-image"
    - run: "./scripts/with_dots.sh make integration-tests"
    - run: "./scripts/with_dots.sh make build"
#    - run: if [ "${{ github.ref }}" = "main" ]; then ./scripts/with_dots.sh make push-cache; fi
    - run: echo "Tests were run before build"
#    - run: "./scripts/with_dots.sh make push-image"
#      if: "${{ github.event_name == 'push' && github.ref == 'refs/heads/main' || -n  ${{ github.ref }} }}"
    - run: make tag
      if: "${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}"
#    - run: make release
#      if: "${{ github.event_name == 'push' && }}"
